// jQuery textntags plugin
!function(a,b){function c(a){return function(c,d){var e={};return d?b.each(a,function(a,b){e[a]=c[b]}):b.each(a,function(a,b){e[b]=c[a]}),e}}var d={V:86,Z:90,BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35,DELETE:46},e={onDataRequest:a.noop,realValOnSubmit:!0,triggers:{"@":{}},templates:{wrapper:b.template('<div class="textntags-wrapper"></div>'),beautifier:b.template('<div class="textntags-beautifier"><div></div></div>'),tagHighlight:b.template('<strong class="<%= class_name %>"><span>$<%= idx %></span></strong>'),tagList:b.template('<div class="textntags-tag-list"></div>'),tagsListItem:b.template("<li><%= title %></li>"),tagsListItemImage:b.template('<img src="<%= img %>" />'),tagsListItemIcon:b.template('<div class="icon <%= no_img_class %>"></div>')}},f={minChars:2,uniqueTags:!0,showImageOrIcon:!0,keys_map:{id:"id",title:"name",description:"",img:"avatar",no_img_class:"icon",type:"type"},syntax:b.template("@[[<%= id %>:<%= type %>:<%= title %>]]"),parser:/(@)\[\[(\d+):([\w\s\.\-]+):([^\]]+)\]\]/gi,parserGroups:{id:2,type:3,title:4},classes:{tagsDropDown:"",tagActiveDropDown:"active",tagHighlight:""}},g=b.memoize(c),h={htmlEncode:function(a){return b.escape(a)},highlightTerm:function(a,b){return b||b.length?a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):a},setCaratPosition:function(a,b){if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()}},i=function(c){function i(c){return null!=Q?!1:(Q=a.extend(!0,{},e,c),delete Q.triggers[""],b.each(Q.triggers,function(c,d){if(Q.triggers[d]=a.extend(!0,{},f,c),b.find(Y,function(a){return a===d}))var e="\\"+d;else var e=d;Q.triggers[d].finder=new RegExp(e+"\\S+(\\s+\\S+)?\\s?$","gi")}),H=Q.templates,!0)}function j(){J=a(c).bind({click:t,keydown:u,keypress:v,keyup:w,input:x,blur:y}),I=J.wrapAll(a(H.wrapper())).parent(),Q.realValOnSubmit&&J.closest("form").bind("submit.textntags",function(){I.css("visibility","hidden"),J.val(p())})}function k(){L=a(H.tagList()),L.appendTo(I),L.delegate("li","mousedown",A)}function l(){K=a(H.beautifier()),K.prependTo(I)}function m(){var a=n(),c=q(a);if(N=c.tagsCollection,J.val(c.plain_text),r(),N.length>0){var d=b.uniq(b.map(N,function(a){return a[3]}));J.trigger("tagsAdded.textntags",[d])}}function n(){return J.val()}function o(a){var c=a||p();return c=c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),b.each(Q.triggers,function(a){var b=H.tagHighlight({idx:a.parserGroups.title,class_name:a.classes.tagHighlight});c=c.replace(a.parser,b)}),c=c.replace(/\n/g,"<br />&shy;"),c=c.replace(/ {2}/g," &nbsp;")+"&shy;"}function p(){var a,c=n(),d=0,e=Q.triggers;return a=b.map(N,function(a){var b=a[0]-d,f=b>0?c.substr(d,b):"",h=g(e[a[2]].keys_map),i=e[a[2]].syntax(h(a[3],!1));return d=a[0]+a[1],f+i}),a.join("")+c.substr(d)}function q(a){if(0==b.isString(a))return null;var c=""+a,d=[],e=Q.triggers;return b.each(e,function(c,e){for(var f,g,h,i=a.split(c.parser),j=0,k=0,l=i.length,m=b.max(c.parserGroups);l>j;)i[j]==e?(f={},b.each(c.parserGroups,function(a,b){f[c.keys_map[b]]=i[j+a-1],"title"==b&&(g=i[j+a-1].length)}),d.push([k,g,e,f]),h=g,j+=m):(h=i[j].length,j+=1),k+=h}),d=b.sortBy(d,function(a){return a[0]}),b.each(e,function(a){c=c.replace(a.parser,"$"+a.parserGroups.title)}),{plain_text:c,tagged_text:a,tagsCollection:d}}function r(){K.find("div").html(o()),J.css("height",K.outerHeight()+"px")}function s(c){c=c||0;var d,e,f=navigator.userAgent.match(/webkit/i)?0:-1,g=J[0].selectionStart+f,h=J.val().substr(0,g+c),i=null;h&&h.length&&(d=b.find(Q.triggers,function(a,b){var c=h.match(a.finder);return c?(i=b,e=c[0].substr(b.length),!0):!1}),!i||d&&e.length<d.minChars?z():(P=e,O=i,b.defer(b.bind(G,this,P,i))))}function t(){s(0)}function u(a){var c=d,e=J[0].selectionStart,f=J[0].selectionEnd,g=J.val();switch(R=f-e,S=g.length,T=a.keyCode,a.keyCode){case c.UP:case c.DOWN:if(!L.is(":visible"))return!0;var h=null;return h=a.keyCode==c.DOWN?M&&M.length?M.next():L.find("li").first():M&&M.length?M.prev():L.find("li").last(),E(h,Q.triggers[O].classes.tagActiveDropDown),!1;case c.RETURN:case c.TAB:return M&&M.length?(U=!0,M.mousedown(),!1):!0;case c.BACKSPACE:case c.DELETE:return a.keyCode==c.BACKSPACE&&e==f&&e>0&&(e-=1),f>e&&(B(e,f),C(e,e-f)),!0;case c.LEFT:case c.RIGHT:case c.HOME:case c.END:b.defer(function(){s.call(this,0)});break;case c.V:a.ctrlKey&&(V=!0,W=e,X=f-e,B(e,f));break;case c.Z:if(a.ctrlKey&&!a.altKey)return!1}return!0}function v(a){a.keyCode==d.RETURN&&r(J.val()),U&&((a.keyCode==d.RETURN||a.keyCode==d.TAB)&&a.preventDefault(),U=!1)}function w(){if(V){if(V=!1,R>0)return;var a=(J[0].selectionStart,J[0].selectionEnd);C(W,a-W-X),r()}}function x(){var b=navigator.userAgent.match(/webkit/i)?0:-1;if(T!=d.BACKSPACE&&T!=d.DELETE)if(R>0){var c=J[0].selectionStart+b,e=R,f=c+e,g=J.val().length-S;B(c,f),C(f,g)}else if(!V){var c=J[0].selectionStart+b,f=J[0].selectionEnd+b,e=f-c;T==d.RETURN?(C(c-1,1),B(c,c)):(C(c,1),B(c,c+1))}r(),s(1)}function y(){b.delay(z,100)}function z(){M=null,L.hide().empty()}function A(){return D(a(this).data("tag")),!1}function B(a,c){var d=[];N=b.filter(N,function(b){var e=b[0],f=e+b[1],g=e>=a&&c>e||f>a&&c>=f||a>e&&f>c;return g&&d.push(b[3]),!g}),d.length>0&&J.trigger("tagsRemoved.textntags",[d])}function C(a,c){N=b.map(N,function(b){return b[0]>=a&&(b[0]+=c),b})}function D(a){var c=Q.triggers[O],d=g(c.keys_map),e=d(a,!1),f=n(),i=J[0].selectionStart,j=i-O.length-P.length,k=j+e.title.length,l=f.substr(0,j),m=f.substr(i),o=l+e.title+m;C(i,k-i),a[c.keys_map.id]=""+a[c.keys_map.id],N.push([j,e.title.length,O,a]),N=b.sortBy(N,function(a){return a[0]}),O="",P="",z(),J.val(o),r(),J.focus(),h.setCaratPosition(J[0],k),J.trigger("tagsAdded.textntags",[[a]])}function E(a,b){a&&a.length?(a.addClass(b),a.siblings().removeClass(b),M=a):(M.removeClass(b),M=null)}function F(c,d,e){var f=Q.triggers[d];if(f.uniqueTags){var i=f.keys_map.id,j=b.map(N,function(a){return a[3][i]});e=b.reject(e,function(a){return b.include(j,""+a[i])})}if(e.length){var k=a("<ul />").addClass(f.classes.tagsDropDown),l=f.showImageOrIcon?H.tagsListItemImage:H.tagsListItemIcon,m=g(f.keys_map);L.empty().append(k),b.each(e,function(b,d){var e,g=m(b,!1);g.title=h.highlightTerm(h.htmlEncode(g.title),c),e=a(H.tagsListItem(g)).data("tag",b),g.img&&(e=e.prepend(l(g))),e.appendTo(k),0===d&&E(e,f.classes.tagActiveDropDown)}),L.show()}}function G(a,b){b||(b=O),z(),Q.onDataRequest.call(this,"search",a,b,function(c){F(a,b,c)})}var H,I,J,K,L,M,N,O,P,Q=null,R=0,S=0,T=0,U=!1,V=!1,W=0,X=0,Y=["[","^","$",".","|","?","*","+","(",")","\\"];return{init:function(a){i(a)&&(j(),k(),l(),m())},val:function(a){if(b.isString(a)){var c=b.uniq(b.map(N,function(a){return a[3]}));return J.trigger("tagsRemoved.textntags",[c]),J.val(a),void m()}if(b.isFunction(a)){var d=N.length?p():n();a.call(this,d)}},reset:function(){var a=b.uniq(b.map(N,function(a){return a[3]}));J.trigger("tagsRemoved.textntags",[a]),J.val(""),N=[],r()},getTags:function(a){if(b.isFunction(a)){var c=b.map(N,function(a){return a[3]});a.call(this,b.uniq(c))}},getTagsMap:function(a){b.isFunction(a)&&a.call(this,N)},getTagsMapFacebook:function(a){if(b.isFunction(a)){var c={},d=Q.triggers;b.each(N,function(a){var b=g(d[a[2]].keys_map),e=b(a[3],!1);c[a[0]]=[{id:e.id,name:e.title,type:e.type,offset:a[0],length:a[1]}]}),a.call(this,c)}},parseTaggedText:function(a,c){b.isFunction(c)&&c.call(this,q(a))}}};a.fn.textntags=function(c){var d=arguments;return this.each(function(){var e=c,f=a.data(this,"textntags")||a.data(this,"textntags",new i(this));return b.isFunction(f[e])?f[e].apply(this,Array.prototype.slice.call(d,1)):"object"!=typeof e&&e?void a.error("Method "+e+" does not exist"):f.init.call(this,e)})}}(joms.jQuery,_);
